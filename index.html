<!DOCTYPE html>
<html>
<head>
    <title>Job Status Tracker | Cut It Right</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Keep all your existing CSS styles exactly as they are] */
        /* I'm not changing the CSS to avoid breaking your design */
        /* Only showing the JavaScript part that needs updating */
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap">
</head>
<body>
    <div class="container">
        <!-- [Keep all your existing HTML exactly as it is] -->
        <!-- I'm not changing the HTML structure -->
    </div>

    <script>
        // ================= CONFIGURATION =================
        const GOOGLE_SHEET_ID = '18jnpO0wtPz8GJ4QiSB4g0I2nG0uFWOtOauraeMswCUo';
        const FINANCE_SHEET_ID = '1tQdx4DItKR5GjbmYVlFHKIdqvyOZOPE_gUuQcxjSzP4';
        // =================================================
        
        // TEST URLs - try these in your browser to see if they work
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json`;
        const FINANCE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${FINANCE_SHEET_ID}/gviz/tq?tqx=out:json`;
        
        let allJobs = {};
        let allFinancialStatements = {};
        let dataLoaded = false;
        let financeDataLoaded = false;
        let currentJobNumber = '';
        let currentCustomerName = '';
        
        // ========== DEBUGGING HELPER ==========
        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
            // Also update status indicator for debugging
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.innerHTML = `<i class="fas fa-bug"></i><span>${message}</span>`;
            }
        }
        
        async function loadJobData() {
            const indicator = document.getElementById('statusIndicator');
            
            try {
                debugLog('Loading repair data...');
                
                const response = await fetch(SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const text = await response.text();
                debugLog('Raw response received');
                
                // Parse the Google Sheets response
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                const rows = json.table.rows;
                
                debugLog(`Found ${rows.length} rows in sheet`);
                
                allJobs = {};
                rows.forEach((row, index) => {
                    const cells = row.c;
                    
                    // Log first few rows to see structure
                    if (index < 3) {
                        debugLog(`Row ${index} cells:`, cells);
                    }
                    
                    if (cells && cells[0] && cells[0].v) {
                        const jobNumber = cells[0].v.toString().trim().toLowerCase();
                        allJobs[jobNumber] = {
                            status: cells[1] ? (cells[1].v || 'Awaiting Deposit') : 'Awaiting Deposit',
                            price: cells[2] ? formatPrice(cells[2].v) : 'Not quoted',
                            date: cells[3] ? (cells[3].v || 'Today') : 'Today',
                            notes: cells[4] ? (cells[4].v || '') : ''
                        };
                    }
                });
                
                dataLoaded = true;
                const count = Object.keys(allJobs).length;
                debugLog(`Loaded ${count} repair jobs`);
                indicator.innerHTML = `<i class="fas fa-check-circle"></i><span>Repair data loaded (${count} jobs)</span>`;
                
            } catch (error) {
                console.error('Failed to load data:', error);
                debugLog(`Error: ${error.message}`);
                
                // Fallback data
                allJobs = {
                    'j1001': { 
                        status: 'Awaiting Deposit', 
                        price: 'R 850.00', 
                        date: 'Today', 
                        notes: 'Lawnmower repair' 
                    }
                };
                dataLoaded = true;
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Using fallback repair data</span>';
            }
        }
        
        async function loadFinancialData() {
            debugLog('Loading financial data...');
            
            try {
                const response = await fetch(FINANCE_SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const text = await response.text();
                debugLog('Finance sheet raw response received');
                
                // Check if response is valid
                if (!text.includes('google.visualization.Query.setResponse')) {
                    throw new Error('Invalid Google Sheets response');
                }
                
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                const rows = json.table.rows;
                
                debugLog(`Finance sheet has ${rows.length} rows`);
                
                allFinancialStatements = {};
                
                // Log column headers
                if (json.table.cols && json.table.cols.length > 0) {
                    const headers = json.table.cols.map(col => col.label || 'No label');
                    debugLog('Column headers:', headers);
                }
                
                rows.forEach((row, index) => {
                    const cells = row.c;
                    
                    // Log first 3 rows for debugging
                    if (index < 3) {
                        debugLog(`Finance Row ${index}:`, cells ? cells.map(c => c ? c.v : 'null') : 'empty');
                    }
                    
                    if (cells && cells[0] && cells[0].v) {
                        const customerName = cells[0].v.toString().trim().toLowerCase();
                        
                        // Log the customer name found
                        debugLog(`Found customer: ${customerName}`);
                        
                        // Map columns - adjust these indices based on your sheet structure
                        allFinancialStatements[customerName] = {
                            // Try different column indices - your sheet might have different order
                            loanStatus: cells[1] ? String(cells[1].v || 'Active') : 'Active',
                            loanAmount: cells[2] ? formatPrice(cells[2].v) : 'R 0.00',
                            interest: cells[3] ? String(cells[3].v) + '%' : '0%',
                            totalPayable: cells[4] ? formatPrice(cells[4].v) : 'R 0.00',
                            startDate: cells[5] ? formatDate(cells[5].v) : 'N/A',
                            dueDate: cells[6] ? formatDate(cells[6].v) : 'N/A',
                            interestAmount: cells[7] ? formatPrice(cells[7].v) : 'R 0.00',
                            nextPayment: cells[8] ? formatPrice(cells[8].v) : 'R 0.00',
                            paymentStatus: cells[9] ? String(cells[9].v || 'No payment due') : 'No payment due'
                        };
                        
                        // Alternative mapping - try if above doesn't work
                        // allFinancialStatements[customerName] = {
                        //     loanStatus: cells[1] ? String(cells[1].v) : 'Active',
                        //     loanAmount: formatPrice(cells[2]?.v),
                        //     interest: cells[3] ? String(cells[3].v) + '%' : '0%',
                        //     totalPayable: formatPrice(cells[4]?.v),
                        //     startDate: formatDate(cells[5]?.v),
                        //     dueDate: formatDate(cells[6]?.v),
                        //     interestAmount: formatPrice(cells[7]?.v),
                        //     nextPayment: formatPrice(cells[8]?.v),
                        //     paymentStatus: cells[9] ? String(cells[9].v) : 'No payment due'
                        // };
                    }
                });
                
                financeDataLoaded = true;
                const count = Object.keys(allFinancialStatements).length;
                debugLog(`Loaded ${count} financial statements`);
                
                // Show loaded customers in console for debugging
                console.log('Loaded customers:', Object.keys(allFinancialStatements));
                
            } catch (error) {
                console.error('Failed to load financial data:', error);
                debugLog(`Finance Error: ${error.message}`);
                
                // Fallback data for testing
                allFinancialStatements = {
                    'test customer': {
                        loanStatus: 'Active',
                        loanAmount: 'R 1,000.00',
                        interest: '10%',
                        totalPayable: 'R 1,100.00',
                        startDate: '2024-01-01',
                        dueDate: '2024-12-31',
                        interestAmount: 'R 100.00',
                        nextPayment: 'R 100.00',
                        paymentStatus: 'Next payment due next month'
                    },
                    'john doe': {
                        loanStatus: 'Active',
                        loanAmount: 'R 5,000.00',
                        interest: '15%',
                        totalPayable: 'R 5,750.00',
                        startDate: '2024-01-15',
                        dueDate: '2024-07-15',
                        interestAmount: 'R 750.00',
                        nextPayment: 'R 500.00',
                        paymentStatus: 'Payment due on 2024-04-15'
                    }
                };
                financeDataLoaded = true;
                debugLog('Using fallback financial data');
            }
        }
        
        function formatPrice(value) {
            if (!value && value !== 0) return 'R 0.00';
            if (typeof value === 'string') {
                value = parseFloat(value.replace(/[^0-9.-]+/g, ""));
            }
            if (isNaN(value)) return 'R 0.00';
            
            return 'R ' + value.toLocaleString('en-ZA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function formatDate(value) {
            if (!value) return 'N/A';
            
            // If it's already a string, return as is
            if (typeof value === 'string') return value;
            
            // If it's a date object or timestamp
            try {
                if (typeof value === 'number') {
                    // Google Sheets dates are sometimes serial numbers
                    const date = new Date((value - 25569) * 86400 * 1000);
                    return date.toISOString().split('T')[0];
                } else {
                    const date = new Date(value);
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {
                return String(value);
            }
        }
        
        // ========== TEST FUNCTION ==========
        function testSheetConnection() {
            debugLog('Testing sheet connection...');
            
            // Test the finance sheet URL
            const testUrl = FINANCE_SHEET_URL;
            debugLog(`Testing URL: ${testUrl}`);
            
            fetch(testUrl)
                .then(response => {
                    debugLog(`Response status: ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    debugLog('Got response text');
                    if (text.includes('google.visualization.Query.setResponse')) {
                        debugLog('✓ Sheet is accessible and returning data');
                    } else {
                        debugLog('✗ Sheet returned unexpected format');
                    }
                })
                .catch(error => {
                    debugLog(`✗ Connection failed: ${error.message}`);
                });
        }
        
        async function searchFinancialStatement() {
            // First, test if we have data loaded
            if (!financeDataLoaded) {
                debugLog('Loading financial data first...');
                await loadFinancialData();
            }
            
            // Show available customers for debugging
            console.log('Available customers:', Object.keys(allFinancialStatements));
            
            // Prompt for customer name
            const customerName = prompt("Please enter your full name to view your financial statement:\n\nAvailable names: " + 
                Object.keys(allFinancialStatements).map(name => 
                    name.charAt(0).toUpperCase() + name.slice(1)
                ).join(', '));
            
            if (!customerName || customerName.trim() === '') {
                showFinanceError('Please enter your name to search for your financial statement.');
                return;
            }
            
            const loading = document.getElementById('financeLoading');
            const error = document.getElementById('financeError');
            const results = document.getElementById('financeResults');
            const financeButtonText = document.getElementById('financeButtonText');
            
            // Hide other sections
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            loading.style.display = 'block';
            error.style.display = 'none';
            results.style.display = 'none';
            currentCustomerName = customerName.trim().toLowerCase();
            
            debugLog(`Searching for: "${currentCustomerName}"`);
            debugLog(`Exact match? ${currentCustomerName in allFinancialStatements}`);
            
            // Also try partial matches
            const partialMatches = Object.keys(allFinancialStatements).filter(name => 
                name.includes(currentCustomerName) || currentCustomerName.includes(name)
            );
            debugLog(`Partial matches: ${partialMatches.join(', ')}`);
            
            setTimeout(() => {
                loading.style.display = 'none';
                
                if (allFinancialStatements[currentCustomerName]) {
                    displayFinancialStatement(currentCustomerName, allFinancialStatements[currentCustomerName]);
                    debugLog(`Found exact match for ${currentCustomerName}`);
                } else if (partialMatches.length > 0) {
                    // Try first partial match
                    const matchedName = partialMatches[0];
                    displayFinancialStatement(matchedName, allFinancialStatements[matchedName]);
                    debugLog(`Using partial match: ${matchedName}`);
                } else {
                    showFinanceError(`No financial statement found for "${customerName}".\n\nPlease check:\n1. Spelling of your name\n2. Contact us if you think there's an error\n\nAvailable names: ${Object.keys(allFinancialStatements).map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(', ')}`);
                    debugLog(`No match found. Available: ${Object.keys(allFinancialStatements).join(', ')}`);
                }
            }, 500);
        }
        
        // [Keep all other functions exactly as they were]
        // getStatusIcon, getLoanStatusIcon, togglePayment, showEFT, showWhatsApp, 
        // searchJob, displayJob, displayFinancialStatement, showError, showFinanceError
        
        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            debugLog('Initializing...');
            
            // Load both datasets
            loadJobData();
            loadFinancialData();
            
            // Test connection on load
            setTimeout(testSheetConnection, 1000);
            
            // Set up intervals
            setInterval(loadJobData, 2 * 60 * 1000);
            setInterval(loadFinancialData, 2 * 60 * 1000);
            
            // Set up enter key for job search
            document.getElementById('jobNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchJob();
                }
            });
            
            document.getElementById('jobNumber').focus();
        });
        
        // ========== ADD A TEST BUTTON TO DEBUG ==========
        // Add this to your HTML temporarily:
        // <button onclick="testSheetConnection()" style="position: fixed; top: 10px; right: 10px; z-index: 1000;">Test Connection</button>
    </script>
</body>
</html>
