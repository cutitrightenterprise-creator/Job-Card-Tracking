<!DOCTYPE html>
<html>
<head>
    <title>Job Tracker - Live from Google Sheets</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .box { background: white; padding: 30px; max-width: 500px; margin: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #007749; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #FFB81C; color: black; border: none; padding: 12px; width: 100%; font-size: 16px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .result { background: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
        .update { font-size: 12px; color: #666; text-align: center; margin-top: 10px; }
    </style>
    <!-- Load Tabletop.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.6.2/tabletop.min.js"></script>
</head>
<body>
    <div class="box">
        <h1>Track Your Job</h1>
        <p>Enter job number (e.g. j1234):</p>
        
        <input type="text" id="jobNumber" placeholder="j1234" oninput="this.value = this.value.toLowerCase()">
        <button onclick="findJob()">CHECK STATUS</button>
        
        <div class="update" id="lastUpdate">
            Loading job data...
        </div>
        
        <div class="result" id="result">
            <h3>Job Status:</h3>
            <p><strong>Job:</strong> <span id="resultNumber"></span></p>
            <p><strong>Status:</strong> <span id="resultStatus"></span></p>
            <p><strong>Updated:</strong> <span id="resultDate"></span></p>
            <p><strong>Notes:</strong> <span id="resultNotes"></span></p>
        </div>
        
        <div class="error" id="error">
            Job not found.
        </div>
    </div>

    <script>
        const SHEET_ID = 18jnpO0wtPz8GJ4QiSB4g0I2nG0uFWOtOauraeMswCUo
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/`;
        
        let jobData = {}; // This stores all jobs
        let lastUpdated = '';
        
        // Load data from Google Sheets
        async function loadSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // Parse the JSON (Google Sheets adds some wrapper text)
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                // Convert to simple object
                jobData = {};
                json.table.rows.forEach(row => {
                    const jobNumber = row.c[0]?.v?.toString().toLowerCase() || '';
                    if (jobNumber) {
                        jobData[jobNumber] = {
                            status: row.c[1]?.v || 'Unknown',
                            date: row.c[2]?.v || 'Not specified',
                            notes: row.c[3]?.v || ''
                        };
                    }
                });
                
                lastUpdated = new Date().toLocaleTimeString('en-ZA');
                document.getElementById('lastUpdate').innerHTML = 
                    `✅ Live data loaded at ${lastUpdated} <br><small>(${Object.keys(jobData).length} jobs in system)</small>`;
                    
                console.log('Data loaded:', Object.keys(jobData).length, 'jobs');
                
            } catch (error) {
                console.error('Error loading sheet:', error);
                document.getElementById('lastUpdate').innerHTML = 
                    '⚠️ Could not load data. Using last saved version.';
            }
        }
        
        // Find a job
        function findJob() {
            const jobNumber = document.getElementById('jobNumber').value.trim().toLowerCase();
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('error');
            
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            if (!jobNumber) {
                showError('Please enter a job number');
                return;
            }
            
            if (jobData[jobNumber]) {
                const job = jobData[jobNumber];
                
                document.getElementById('resultNumber').innerText = jobNumber.toUpperCase();
                document.getElementById('resultStatus').innerText = job.status;
                document.getElementById('resultDate').innerText = job.date;
                document.getElementById('resultNotes').innerText = job.notes || 'No notes';
                
                resultDiv.style.display = 'block';
                
                // Clear input
                document.getElementById('jobNumber').value = '';
            } else {
                showError(`Job "${jobNumber.toUpperCase()}" not found.`);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerText = message;
            errorDiv.style.display = 'block';
        }
        
        // Auto-refresh data every 5 minutes
        function startAutoRefresh() {
            loadSheetData(); // Load immediately
            setInterval(loadSheetData, 5 * 60 * 1000); // Refresh every 5 minutes
        }
        
        // Press Enter to search
        document.getElementById('jobNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') findJob();
        });
        
        // Load data when page opens
        window.addEventListener('DOMContentLoaded', startAutoRefresh);
    </script>
</body>
</html>
